<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wfinance | Guardian</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300;14..32,400;14..32,500;14..32,600;14..32,700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@0.426.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <!-- GAP #2: MSAL.js for Azure AD authentication -->
    <script src="https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js"></script>
    <style>
        *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
        :root {
            --sidebar-w: 232px;
            --bg: #F8F9FB;
            --bg-sidebar: #1A1631;
            --bg-sidebar-hover: rgba(255,255,255,0.06);
            --bg-sidebar-active: rgba(255,255,255,0.10);
            --white: #FFFFFF;
            --hover: #F4F5F7;
            --pressed: #EDEEF1;
            --primary: #5746AF;
            --primary-hover: #6B5BC4;
            --primary-dim: rgba(87,70,175,0.06);
            --primary-soft: rgba(87,70,175,0.10);
            --success: #0D9668;
            --success-dim: rgba(13,150,104,0.07);
            --danger: #D93036;
            --danger-dim: rgba(217,48,54,0.07);
            --info: #2D7FF9;
            --info-dim: rgba(45,127,249,0.07);
            --warn: #CF8A12;
            --warn-dim: rgba(207,138,18,0.07);
            --border: #E8EAF0;
            --border-strong: #D4D7DE;
            --t1: #1A1D26;
            --t2: #5E6370;
            --t3: #9096A2;
            --t4: #B4B9C5;
            --radius: 10px;
            --radius-lg: 14px;
            --shadow-xs: 0 1px 2px rgba(16,24,40,0.04);
            --shadow-sm: 0 1px 3px rgba(16,24,40,0.06),0 1px 2px rgba(16,24,40,0.04);
            --shadow-md: 0 4px 8px -2px rgba(16,24,40,0.06),0 2px 4px -2px rgba(16,24,40,0.04);
        }
        body { font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif; background:var(--bg); color:var(--t1); min-height:100vh; display:flex; font-size:13px; line-height:1.5; -webkit-font-smoothing:antialiased; }

        /* ============ SIDEBAR ============ */
        .sidebar { width:var(--sidebar-w); min-height:100vh; background:var(--bg-sidebar); display:flex; flex-direction:column; padding:24px 12px; position:fixed; left:0; top:0; bottom:0; z-index:50; }
        .sidebar-brand { display:flex; align-items:center; gap:10px; padding:0 10px 20px; border-bottom:1px solid rgba(255,255,255,0.08); margin-bottom:20px; }
        .sidebar-logo { width:32px; height:32px; background:linear-gradient(135deg,#7C6AE8,#5746AF); border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:14px; color:#fff; box-shadow:0 2px 8px rgba(87,70,175,0.4); }
        .sidebar-title { font-size:14px; font-weight:600; color:#fff; letter-spacing:-0.2px; }
        .sidebar-subtitle { font-size:10px; color:rgba(255,255,255,0.35); letter-spacing:0.3px; }
        .sidebar-section { font-size:10px; font-weight:600; color:rgba(255,255,255,0.30); text-transform:uppercase; letter-spacing:1px; padding:16px 10px 8px; }
        .sidebar-item { display:flex; align-items:center; gap:10px; padding:9px 10px; border-radius:8px; cursor:pointer; color:rgba(255,255,255,0.55); font-size:13px; font-weight:450; transition:all 0.15s; }
        .sidebar-item:hover { background:var(--bg-sidebar-hover); color:rgba(255,255,255,0.80); }
        .sidebar-item.active { background:var(--bg-sidebar-active); color:#fff; }
        .sidebar-item i { width:18px; height:18px; opacity:0.7; }
        .sidebar-item.active i { opacity:1; }
        .sidebar-badge { margin-left:auto; font-size:10px; font-weight:600; background:rgba(217,48,54,0.25); color:#FF6B6B; padding:1px 7px; border-radius:10px; }
        .sidebar-spacer { flex:1; }
        .sidebar-footer { padding:12px 10px; border-top:1px solid rgba(255,255,255,0.08); margin-top:12px; }
        .sidebar-user { display:flex; align-items:center; gap:10px; color:rgba(255,255,255,0.60); font-size:12px; cursor:pointer; }
        .sidebar-avatar { width:28px; height:28px; border-radius:50%; background:linear-gradient(135deg,#7C6AE8,#5746AF); display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:600; color:#fff; }
        .sidebar-status-row { display:flex; gap:6px; padding:0 10px; margin-top:4px; }
        .status-dot { width:7px; height:7px; border-radius:50%; background:var(--t4); transition:all 0.3s; }
        .status-dot.live { background:var(--success); box-shadow:0 0 6px rgba(13,150,104,0.5); }

        /* ============ MAIN ============ */
        .main { margin-left:var(--sidebar-w); flex:1; padding:28px 36px 60px; max-width:calc(100% - var(--sidebar-w)); }
        .page { display:none; }
        .page.active { display:block; }

        .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:28px; }
        .topbar-left h1 { font-size:20px; font-weight:600; letter-spacing:-0.3px; color:var(--t1); }
        .topbar-left p { font-size:12px; color:var(--t3); margin-top:2px; }
        .topbar-right { display:flex; align-items:center; gap:10px; }
        .pill { font-size:11px; padding:5px 14px; border-radius:20px; font-weight:600; font-family:'JetBrains Mono',monospace; }
        .pill-primary { background:var(--primary-dim); color:var(--primary); }
        .pill-success { background:var(--success-dim); color:var(--success); }

        /* ---- Cards ---- */
        .card { background:var(--white); border:1px solid var(--border); border-radius:var(--radius-lg); padding:22px; box-shadow:var(--shadow-xs); transition:box-shadow 0.15s,border-color 0.15s; animation:scaleIn 0.4s ease both; }
        .card:hover { box-shadow:var(--shadow-sm); }
        .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
        .card-title { font-size:12px; font-weight:600; color:var(--t2); text-transform:uppercase; letter-spacing:0.5px; display:flex; align-items:center; gap:8px; }
        .card-title i { width:15px; height:15px; color:var(--primary); opacity:0.6; }

        /* ---- KPI Grid ---- */
        .kpi-grid { display:grid; grid-template-columns:repeat(6,1fr); gap:14px; }
        .kpi-card { background:var(--white); border:1px solid var(--border); border-radius:var(--radius); padding:18px 16px; box-shadow:var(--shadow-xs); position:relative; overflow:hidden; animation:fadeUp 0.5s ease both; transition:transform 0.2s,box-shadow 0.2s,border-color 0.2s; }
        .kpi-card:hover { transform:translateY(-3px); box-shadow:var(--shadow-md); border-color:var(--border-strong); }
        .kpi-card::before { content:''; position:absolute; left:0; top:0; bottom:0; width:3px; background:var(--border); border-radius:0 2px 2px 0; }
        .kpi-card.purple::before { background:var(--primary); }
        .kpi-card.green::before { background:var(--success); }
        .kpi-card.blue::before { background:var(--info); }
        .kpi-card.red::before { background:var(--danger); }
        .kpi-label { font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:0.8px; color:var(--t3); margin-bottom:8px; }
        .kpi-value { font-size:22px; font-weight:700; color:var(--t1); font-variant-numeric:tabular-nums; letter-spacing:-0.5px; }
        .kpi-card.purple .kpi-value { color:var(--primary); }
        .kpi-card.green .kpi-value { color:var(--success); }
        .kpi-card.blue .kpi-value { color:var(--info); }
        .kpi-card.red .kpi-value { color:var(--danger); }
        .kpi-sub { font-size:11px; color:var(--t4); margin-top:4px; }

        /* ---- Grids ---- */
        .g2 { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:16px; }
        .g3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; margin-top:16px; }
        .mt { margin-top:16px; }
        .section-title { font-size:15px; font-weight:600; color:var(--t1); margin-top:28px; margin-bottom:14px; display:flex; align-items:center; gap:8px; }
        .section-title i { width:18px; height:18px; color:var(--primary); opacity:0.5; }

        /* ---- Buttons ---- */
        .btn { display:inline-flex; align-items:center; gap:6px; padding:8px 16px; border-radius:8px; border:none; font-weight:600; font-size:12px; cursor:pointer; font-family:'Inter',sans-serif; transition:all 0.12s; line-height:1; }
        .btn:disabled { opacity:0.35; cursor:not-allowed; }
        .btn-primary { background:var(--primary); color:#fff; box-shadow:0 1px 2px rgba(87,70,175,0.3); }
        .btn-primary:hover:not(:disabled) { background:var(--primary-hover); }
        .btn-outline { background:var(--white); color:var(--t2); border:1px solid var(--border); }
        .btn-outline:hover:not(:disabled) { border-color:var(--primary); color:var(--primary); background:var(--primary-dim); }
        .btn-success { background:var(--success); color:#fff; }
        .btn-success:hover:not(:disabled) { background:#0b8159; }
        .btn-danger { background:var(--danger); color:#fff; }
        .btn-sm { padding:5px 10px; font-size:11px; border-radius:6px; }

        /* ---- Tables ---- */
        .tbl { width:100%; border-collapse:collapse; font-size:12px; }
        .tbl th { text-align:left; font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; color:var(--t3); padding:10px 12px; border-bottom:1px solid var(--border); background:var(--bg); }
        .tbl th:last-child { text-align:right; }
        .tbl td { padding:9px 12px; border-bottom:1px solid var(--border); color:var(--t1); vertical-align:middle; }
        .tbl tr:last-child td { border-bottom:none; }
        .tbl tr:hover td { background:var(--hover); }
        .tbl .sub td { padding-left:28px; color:var(--t2); font-size:12px; }
        .tbl .total td { font-weight:700; border-top:2px solid var(--border-strong); padding-top:12px; color:var(--primary); }
        .tbl .section-row td { font-weight:600; color:var(--t3); font-size:10px; text-transform:uppercase; letter-spacing:0.5px; padding-top:14px; }
        .tbl .num { text-align:right; font-family:'JetBrains Mono',monospace; font-size:12px; }
        .tbl .positive { color:var(--success); }
        .tbl .negative { color:var(--danger); }

        /* ---- Transaction rows ---- */
        .tx-row { display:flex; justify-content:space-between; align-items:center; padding:11px 16px; border-bottom:1px solid var(--border); transition:background 0.1s; }
        .tx-row:last-child { border-bottom:none; }
        .tx-row:hover { background:var(--hover); }
        .tx-left { display:flex; align-items:center; gap:12px; flex:1; min-width:0; }
        .tx-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
        .tx-dot.in { background:var(--success); }
        .tx-dot.out { background:var(--danger); }
        .tx-name { font-size:13px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .tx-meta { font-size:11px; color:var(--t3); margin-top:1px; display:flex; gap:6px; align-items:center; }
        .tx-amount { font-family:'JetBrains Mono',monospace; font-size:13px; font-weight:500; text-align:right; white-space:nowrap; }
        .tx-conf { font-size:10px; color:var(--t4); text-align:right; margin-top:1px; }
        .tx-actions { display:flex; gap:4px; margin-left:12px; flex-shrink:0; }
        .tag { font-size:9px; padding:2px 7px; border-radius:4px; font-weight:600; letter-spacing:0.2px; }
        .tag-auto { background:var(--success-dim); color:var(--success); }
        .tag-alert { background:var(--danger-dim); color:var(--danger); }
        .tag-review { background:var(--warn-dim); color:var(--warn); }

        /* ---- Category bars ---- */
        .cat-row { padding:12px 16px; border-bottom:1px solid var(--border); }
        .cat-row:last-child { border-bottom:none; }
        .cat-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
        .cat-name { font-size:13px; font-weight:500; }
        .cat-val { font-family:'JetBrains Mono',monospace; font-size:12px; font-weight:500; color:var(--t2); }
        .cat-bar-bg { height:6px; background:var(--bg); border-radius:3px; overflow:hidden; }
        .cat-bar-fill { height:100%; border-radius:3px; background:linear-gradient(90deg,var(--primary),var(--primary-hover)); transition:width 0.6s ease; }
        .cat-count { font-size:10px; color:var(--t4); margin-top:4px; }

        /* ---- Insight cards ---- */
        .insight-card { padding:16px; border-radius:var(--radius); margin-bottom:10px; border-left:3px solid var(--border); }
        .insight-card.danger { background:var(--danger-dim); border-left-color:var(--danger); }
        .insight-card.warning { background:var(--warn-dim); border-left-color:var(--warn); }
        .insight-card.success { background:var(--success-dim); border-left-color:var(--success); }
        .insight-card.info { background:var(--info-dim); border-left-color:var(--info); }
        .insight-title { font-size:13px; font-weight:600; margin-bottom:4px; }
        .insight-card.danger .insight-title { color:var(--danger); }
        .insight-card.warning .insight-title { color:var(--warn); }
        .insight-card.success .insight-title { color:var(--success); }
        .insight-card.info .insight-title { color:var(--info); }
        .insight-text { font-size:12px; color:var(--t2); line-height:1.5; }

        /* ---- Margin summary ---- */
        .margin-summary { display:flex; gap:16px; padding:10px 12px; margin-top:8px; background:var(--bg); border-radius:8px; font-size:11px; color:var(--t3); flex-wrap:wrap; }
        .margin-summary span { display:flex; align-items:center; gap:4px; }
        .margin-summary strong { color:var(--t2); font-weight:600; }

        /* ---- Patrimonio Cards ---- */
        .patrimonio-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:14px; margin-bottom:20px; }
        .patrimonio-card { background:var(--white); border:1px solid var(--border); border-radius:var(--radius); padding:18px 16px; box-shadow:var(--shadow-xs); position:relative; overflow:hidden; transition:transform 0.2s,box-shadow 0.2s,border-color 0.2s; animation:fadeUp 0.5s ease both; }
        .patrimonio-card::before { content:''; position:absolute; left:0; top:0; bottom:0; width:3px; border-radius:0 2px 2px 0; }
        .patrimonio-card.cc::before { background:var(--info); }
        .patrimonio-card.inv::before { background:var(--success); }
        .patrimonio-card.total::before { background:var(--primary); }
        .patrimonio-card:hover { transform:translateY(-3px); box-shadow:var(--shadow-md); border-color:var(--border-strong); }
        .patrimonio-label { font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:0.8px; color:var(--t3); margin-bottom:4px; }
        .patrimonio-nome { font-size:13px; font-weight:500; color:var(--t1); margin-bottom:8px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .patrimonio-valor { font-size:22px; font-weight:700; font-variant-numeric:tabular-nums; letter-spacing:-0.5px; }
        .patrimonio-card.cc .patrimonio-valor { color:var(--info); }
        .patrimonio-card.inv .patrimonio-valor { color:var(--success); }
        .patrimonio-card.total .patrimonio-valor { color:var(--primary); }
        .patrimonio-sub { font-size:11px; color:var(--t4); margin-top:4px; display:flex; align-items:center; gap:4px; }
        .patrimonio-tag { font-size:9px; padding:2px 7px; border-radius:4px; font-weight:600; background:var(--success-dim); color:var(--success); }

        /* ---- Upload ---- */
        .upload-zone { border:2px dashed var(--border); border-radius:var(--radius); padding:36px; text-align:center; cursor:pointer; transition:all 0.15s; }
        .upload-zone:hover,.upload-zone.drag { border-color:var(--primary); background:var(--primary-dim); }
        .upload-zone p { font-size:13px; color:var(--t2); margin-top:10px; }
        .upload-zone small { font-size:11px; color:var(--t4); }
        .upload-zone input { display:none; }

        /* ---- Chart ---- */
        .chart-wrap { position:relative; height:280px; }

        /* ---- Toast ---- */
        .toast-c { position:fixed; bottom:24px; right:24px; display:flex; flex-direction:column; gap:8px; z-index:1000; }
        .toast { padding:12px 18px; border-radius:var(--radius); font-size:13px; font-weight:500; background:var(--white); box-shadow:var(--shadow-md); border-left:3px solid var(--t4); animation:slideIn 0.25s ease; max-width:380px; }
        .toast-ok { border-left-color:var(--success); }
        .toast-err { border-left-color:var(--danger); }
        .toast-info { border-left-color:var(--info); }
        @keyframes slideIn { from { transform:translateX(60px); opacity:0; } }
        @keyframes fadeUp { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:translateY(0); } }
        @keyframes scaleIn { from { opacity:0; transform:scale(0.95); } to { opacity:1; transform:scale(1); } }

        /* ---- Utilities ---- */
        .empty-state { text-align:center; padding:40px 16px; color:var(--t3); font-size:13px; }
        .spinner { width:16px; height:16px; border:2px solid var(--border); border-top-color:var(--primary); border-radius:50%; animation:spin 0.6s linear infinite; display:inline-block; }
        @keyframes spin { to { transform:rotate(360deg); } }

        /* ---- Modal ---- */
        .modal-bg { position:fixed; inset:0; background:rgba(0,0,0,0.4); backdrop-filter:blur(4px); display:none; align-items:center; justify-content:center; z-index:999; }
        .modal-bg.open { display:flex; }
        .modal { background:var(--white); border:1px solid var(--border); border-radius:16px; padding:28px; width:420px; box-shadow:0 24px 64px rgba(0,0,0,0.16); }
        .modal h3 { font-size:16px; font-weight:600; color:var(--t1); margin-bottom:4px; }
        .modal p { font-size:13px; color:var(--t2); margin-bottom:16px; }
        .modal input,.modal select { width:100%; padding:10px 14px; border-radius:8px; border:1px solid var(--border); background:var(--bg); color:var(--t1); font-size:13px; font-family:'Inter',sans-serif; outline:none; transition:border-color 0.15s; }
        .modal input:focus,.modal select:focus { border-color:var(--primary); box-shadow:0 0 0 3px var(--primary-dim); }
        .modal-acts { display:flex; gap:8px; justify-content:flex-end; margin-top:16px; }
        .modal-wide { width:520px; }
        .form-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
        .form-group { margin-bottom:12px; }
        .form-group label { display:block; font-size:11px; font-weight:600; color:var(--t3); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:4px; }

        /* ---- Cadastro table ---- */
        .cad-tbl { width:100%; border-collapse:collapse; font-size:12px; }
        .cad-tbl th { text-align:left; font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; color:var(--t3); padding:10px 12px; border-bottom:1px solid var(--border); background:var(--bg); }
        .cad-tbl td { padding:8px 12px; border-bottom:1px solid var(--border); vertical-align:middle; }
        .cad-tbl tr:last-child td { border-bottom:none; }
        .cad-tbl tr:hover td { background:var(--hover); }
        .cad-tbl .num { text-align:right; font-family:'JetBrains Mono',monospace; }
        .cad-tbl .acts { text-align:right; white-space:nowrap; }
        .badge { display:inline-block; font-size:9px; padding:2px 8px; border-radius:4px; font-weight:600; letter-spacing:0.3px; }
        .badge-RECEITA_DIRETA { background:var(--success-dim); color:var(--success); }
        .badge-RECEITA_FINANCEIRA { background:var(--info-dim); color:var(--info); }
        .badge-CUSTO_VARIAVEL { background:var(--warn-dim); color:var(--warn); }
        .badge-CUSTO_FIXO { background:var(--danger-dim); color:var(--danger); }
        .badge-DESPESA_FINANCEIRA { background:rgba(139,92,246,0.08); color:#7C3AED; }
        .badge-ativa { background:var(--success-dim); color:var(--success); }
        .badge-inativa { background:var(--bg); color:var(--t4); }
        .reclass-select { padding:4px 8px; font-size:11px; border-radius:6px; border:1px solid var(--border); background:var(--white); color:var(--t1); cursor:pointer; max-width:180px; }
        .reclass-select optgroup { font-weight:600; color:var(--primary); background:rgba(87,70,175,0.06); font-size:11px; }

        /* ---- Tabs ---- */
        .tab-bar { display:flex; gap:0; border-bottom:2px solid var(--border); margin-bottom:20px; }
        .tab-btn { padding:10px 20px; font-size:13px; font-weight:600; color:var(--t3); background:none; border:none; border-bottom:2px solid transparent; margin-bottom:-2px; cursor:pointer; font-family:'Inter',sans-serif; transition:all 0.15s; }
        .tab-btn:hover { color:var(--t1); }
        .tab-btn.active { color:var(--primary); border-bottom-color:var(--primary); }
        .tab-panel { display:none; }
        .tab-panel.active { display:block; }

        /* ---- Responsive ---- */
        @media (max-width:1280px) { .kpi-grid { grid-template-columns:repeat(3,1fr); } }
        @media (max-width:1024px) { .sidebar { display:none; } .main { margin-left:0; max-width:100%; } }
        @media (max-width:768px) { .main { padding:16px; } .kpi-grid { grid-template-columns:repeat(2,1fr); } .g2 { grid-template-columns:1fr; } .topbar { flex-direction:column; gap:12px; align-items:flex-start; } }
    </style>
</head>
<body>

<!-- ============ SIDEBAR ============ -->
<aside class="sidebar">
    <div class="sidebar-brand">
        <div class="sidebar-logo">G</div>
        <div>
            <div class="sidebar-title">Guardian</div>
            <div class="sidebar-subtitle">Wfinance Gestao</div>
        </div>
    </div>

    <div class="sidebar-section">Paginas</div>
    <div class="sidebar-item active" data-page="guardian"><i data-lucide="eye"></i> Visao Guardian</div>
    <div class="sidebar-item" data-page="semanal">
        <i data-lucide="calendar-days"></i> Relatorios Semanais
        <span id="approval-badge" class="sidebar-badge" style="display:none">0</span>
    </div>
    <div class="sidebar-item" data-page="cadastros"><i data-lucide="settings"></i> Cadastros</div>

    <div class="sidebar-spacer"></div>

    <div class="sidebar-status-row">
        <div id="dot-inter" class="status-dot" title="Inter API"></div>
        <div id="dot-graph" class="status-dot" title="MS Graph"></div>
        <div id="dot-ai" class="status-dot" title="AI/OCR"></div>
    </div>

    <div class="sidebar-footer">
        <div class="sidebar-user" onclick="handleAuth()">
            <div class="sidebar-avatar" id="user-avatar">?</div>
            <div>
                <div id="user-name" style="font-size:12px;color:rgba(255,255,255,0.75)">Entrar</div>
                <div id="user-role" style="font-size:10px;color:rgba(255,255,255,0.30)">Clique para login</div>
            </div>
        </div>
    </div>
</aside>

<!-- ============ MAIN ============ -->
<div class="main">
    <input id="file-input" type="file" accept=".pdf,.xml,.ofx,.csv" style="display:none" onchange="handleFileSelect(event)">

    <!-- ======== PAGE: SEMANAL ======== -->
    <div id="page-semanal" class="page">
        <header class="topbar">
            <div class="topbar-left">
                <h1>Relatorios Semanais</h1>
                <p>Visao operacional e aprovacoes</p>
            </div>
            <div class="topbar-right">
                <span id="auto-pill" class="pill pill-primary">-- %</span>
                <!-- Upload discreto -->
                <button class="btn btn-outline" onclick="document.getElementById('file-input').click()" style="gap:5px">
                    <i data-lucide="upload-cloud" style="width:14px;height:14px"></i> Importar
                </button>
            </div>
        </header>
        <div id="upload-status" style="margin-bottom:8px"></div>

        <!-- Tabs -->
        <div class="tab-bar">
            <button class="tab-btn active" data-tab="tab-visao">Visao Semanal</button>
            <button class="tab-btn" data-tab="tab-rotinas">Rotinas Diarias</button>
        </div>

        <!-- TAB: Visao Semanal -->
        <div id="tab-visao" class="tab-panel active">
            <!-- Summary Cards -->
            <section class="kpi-grid" style="grid-template-columns:repeat(4,1fr)">
                <div class="kpi-card red"><div class="kpi-label">Pendentes</div><div id="s-pending" class="kpi-value">--</div><div class="kpi-sub">Aguardando aprovacao</div></div>
                <div class="kpi-card green"><div class="kpi-label">Ja Recebido</div><div id="s-recebido" class="kpi-value">--</div><div class="kpi-sub">Mes atual</div></div>
                <div class="kpi-card blue"><div class="kpi-label">Ja Pago</div><div id="s-pago" class="kpi-value">--</div><div class="kpi-sub">Mes atual</div></div>
                <div class="kpi-card purple"><div class="kpi-label">Alertas</div><div id="s-alertas" class="kpi-value">--</div><div class="kpi-sub">Orcamento</div></div>
            </section>

            <!-- Ja Pago / Ja Recebido -->
            <div class="g2">
                <div class="card">
                    <div class="card-header"><div class="card-title" style="color:var(--danger)"><i data-lucide="arrow-down-left" style="color:var(--danger)"></i> Ja Pago (Mes)</div></div>
                    <div id="ja-pago-list"><div class="empty-state">Nenhum pagamento registrado.</div></div>
                </div>
                <div class="card">
                    <div class="card-header"><div class="card-title" style="color:var(--success)"><i data-lucide="arrow-up-right" style="color:var(--success)"></i> Ja Recebido (Mes)</div></div>
                    <div id="ja-recebido-list"><div class="empty-state">Nenhum recebimento registrado.</div></div>
                </div>
            </div>
        </div>

        <!-- TAB: Rotinas Diarias -->
        <div id="tab-rotinas" class="tab-panel">
            <!-- Transacoes para Aprovacao (unificada) -->
            <div class="section-title"><i data-lucide="check-circle"></i> Transacoes para Aprovacao</div>
            <div class="card" id="approval-list" style="padding:0;overflow:hidden">
                <div class="empty-state"><span class="spinner"></span></div>
            </div>

        </div>
    </div>

    <!-- ======== PAGE: CADASTROS ======== -->
    <div id="page-cadastros" class="page">
        <header class="topbar">
            <div class="topbar-left">
                <h1>Cadastros</h1>
                <p>Configuracoes de contas, categorias e parametros</p>
            </div>
        </header>

        <!-- Tabs -->
        <div class="tab-bar">
            <button class="tab-btn active" data-tab="tab-cad-contas">Contas Correntes</button>
            <button class="tab-btn" data-tab="tab-cad-categorias">Categorias</button>
        </div>

        <!-- TAB: Contas Correntes -->
        <div id="tab-cad-contas" class="tab-panel active">
            <div class="section-title"><i data-lucide="landmark"></i> Contas Correntes <button class="btn btn-outline btn-sm" style="margin-left:auto" onclick="openContaModal()">+ Nova Conta</button></div>
            <div class="card" style="padding:0;overflow:hidden">
                <div id="contas-list"><div class="empty-state"><span class="spinner"></span></div></div>
            </div>
        </div>

        <!-- TAB: Categorias -->
        <div id="tab-cad-categorias" class="tab-panel">
            <div class="section-title"><i data-lucide="tag"></i> Categorias <button class="btn btn-outline btn-sm" style="margin-left:auto" onclick="openCategoriaModal()">+ Nova</button></div>
            <div class="card" style="padding:0;overflow:hidden">
                <div id="categorias-list"><div class="empty-state"><span class="spinner"></span></div></div>
            </div>
        </div>
    </div>

    <!-- ======== PAGE: VISAO GUARDIAN ======== -->
    <div id="page-guardian" class="page active">
        <header class="topbar">
            <div class="topbar-left">
                <h1>Visao Guardian</h1>
                <p id="last-sync">Carregando dados...</p>
            </div>
            <div class="topbar-right">
                <span id="health-pill" class="pill pill-primary">--</span>
                <button id="btn-sync" class="btn btn-primary" onclick="runSync()">
                    <i data-lucide="refresh-cw" style="width:14px;height:14px"></i> Sincronizar
                </button>
            </div>
        </header>

        <!-- Tabs -->
        <div class="tab-bar">
            <button class="tab-btn active" data-tab="tab-dashboard">Dashboard</button>
            <button class="tab-btn" data-tab="tab-dre">DRE</button>
            <button class="tab-btn" data-tab="tab-dfc">DFC</button>
        </div>

        <!-- TAB: Dashboard -->
        <div id="tab-dashboard" class="tab-panel active">
            <!-- KPIs -->
            <section class="kpi-grid">
                <div class="kpi-card green"><div class="kpi-label">Indice MC</div><div id="k-mb" class="kpi-value">--</div><div class="kpi-sub">Margem Contribuicao / RL</div></div>
                <div class="kpi-card purple"><div class="kpi-label">Margem Liquida</div><div id="k-ml" class="kpi-value">--</div><div class="kpi-sub">Resultado Liq. / Receita</div></div>
                <div class="kpi-card blue"><div class="kpi-label">Resultado Liquido</div><div id="k-lucro" class="kpi-value">--</div><div class="kpi-sub">Apos IR/CSLL</div></div>
                <div class="kpi-card blue"><div class="kpi-label">Fluxo de Caixa</div><div id="k-fc" class="kpi-value">--</div><div class="kpi-sub">Operacional</div></div>
                <div class="kpi-card green"><div class="kpi-label">Faturamento</div><div id="k-fat" class="kpi-value">--</div><div class="kpi-sub">Mes atual</div></div>
                <div class="kpi-card purple"><div class="kpi-label">Patrimonio</div><div id="k-pat" class="kpi-value">--</div><div class="kpi-sub">Total consolidado</div></div>
            </section>

            <!-- Patrimonio -->
            <div class="section-title" style="margin-top:24px"><i data-lucide="landmark"></i> Visao Patrimonial</div>
            <div id="patrimonio-grid" class="patrimonio-grid">
                <div class="patrimonio-card cc"><div class="patrimonio-label">Conta Corrente</div><div class="patrimonio-nome">Banco Inter PJ</div><div class="patrimonio-valor" style="color:var(--info)">--</div></div>
            </div>

            <!-- Insights -->
            <div class="section-title"><i data-lucide="sparkles"></i> Insights Estrategicos e Preditivos</div>
            <div id="insights-panel" class="card" style="padding:16px"><div class="empty-state"><span class="spinner"></span></div></div>

            <!-- Historico Faturamento + Projecao -->
            <div class="g2">
                <div class="card">
                    <div class="card-header"><div class="card-title"><i data-lucide="bar-chart-3"></i> Historico de Faturamento Mensal</div></div>
                    <div class="chart-wrap"><canvas id="billing-chart"></canvas></div>
                </div>
                <div class="card">
                    <div class="card-header"><div class="card-title"><i data-lucide="trending-up"></i> Projecao 6 Meses</div></div>
                    <div class="chart-wrap"><canvas id="forecast-chart"></canvas></div>
                </div>
            </div>

            <!-- FC Fechamento + Panorama -->
            <div class="g2">
                <div class="card">
                    <div class="card-header"><div class="card-title"><i data-lucide="target"></i> Fluxo de Caixa — Fechamento do Mes</div></div>
                    <div id="fc-panel"><div class="empty-state"><span class="spinner"></span></div></div>
                </div>
                <div class="card">
                    <div class="card-header"><div class="card-title"><i data-lucide="gauge"></i> Panorama Geral</div></div>
                    <div id="panorama-panel"><div class="empty-state"><span class="spinner"></span></div></div>
                </div>
            </div>

            <!-- Categorias de Despesas -->
            <div class="card mt">
                <div class="card-header"><div class="card-title"><i data-lucide="layers"></i> Categorias de Despesas</div></div>
                <div id="cat-list"><div class="empty-state"><span class="spinner"></span></div></div>
            </div>
        </div>

        <!-- TAB: DRE -->
        <div id="tab-dre" class="tab-panel">
            <div class="card">
                <div class="card-header"><div class="card-title"><i data-lucide="file-spreadsheet"></i> DRE — Analise de Margens</div></div>
                <div id="dre-body"><div class="empty-state"><span class="spinner"></span></div></div>
            </div>
        </div>

        <!-- TAB: DFC -->
        <div id="tab-dfc" class="tab-panel">
            <div class="card">
                <div class="card-header"><div class="card-title"><i data-lucide="wallet"></i> DFC — Demonstracao de Fluxo de Caixa Completo</div></div>
                <div id="dfc-body"><div class="empty-state"><span class="spinner"></span></div></div>
            </div>
        </div>
    </div>
</div>

<div id="toasts" class="toast-c"></div>

<!-- Modal: Categoria -->
<div id="modal-categoria" class="modal-bg" onclick="if(event.target===this)closeCategoriaModal()">
    <div class="modal">
        <h3 id="modal-cat-title">Nova Categoria</h3>
        <p>Preencha os dados da categoria financeira.</p>
        <form id="cat-form" onsubmit="saveCategoria(event)">
            <input type="hidden" id="cat-id">
            <div class="form-group">
                <label>Nome</label>
                <input type="text" id="cat-nome" placeholder="Ex: Marketing Digital" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Tipo DRE</label>
                    <select id="cat-tipo" onchange="updateGrupoOptions()">
                        <option value="CUSTO_VARIAVEL">Custo/Despesa Variavel</option>
                        <option value="CUSTO_FIXO">Custo/Despesa Fixo</option>
                        <option value="DESPESA_FINANCEIRA">Despesa Financeira</option>
                        <option value="RECEITA_DIRETA">Receita Direta</option>
                        <option value="RECEITA_FINANCEIRA">Receita Financeira</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Grupo Contabil</label>
                    <select id="cat-grupo"></select>
                </div>
            </div>
            <div class="form-group">
                <label>Orcamento Mensal (R$)</label>
                <input type="number" id="cat-orcamento" step="0.01" value="0" min="0">
            </div>
            <div class="modal-acts">
                <button type="button" class="btn btn-outline" onclick="closeCategoriaModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Salvar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal: Conta Corrente -->
<div id="modal-conta" class="modal-bg" onclick="if(event.target===this)closeContaModal()">
    <div class="modal">
        <h3 id="modal-conta-title">Nova Conta Corrente</h3>
        <p>Cadastre uma conta bancaria para acompanhamento patrimonial.</p>
        <form id="conta-form" onsubmit="saveConta(event)">
            <input type="hidden" id="conta-id">
            <div class="form-group">
                <label>Nome da Conta</label>
                <input type="text" id="conta-nome" placeholder="Ex: Banco Inter PJ" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Banco</label>
                    <input type="text" id="conta-banco" placeholder="Ex: Banco Inter" required>
                </div>
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="conta-tipo">
                        <option value="corrente">Conta Corrente</option>
                        <option value="poupanca">Poupanca</option>
                        <option value="investimento">Investimento</option>
                        <option value="cartao">Cartao de Credito</option>
                        <option value="caixa">Caixa</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Agencia</label>
                    <input type="text" id="conta-agencia" placeholder="0001">
                </div>
                <div class="form-group">
                    <label>Conta</label>
                    <input type="text" id="conta-numero" placeholder="12345-6">
                </div>
            </div>
            <div class="form-group">
                <label>Saldo Inicial (R$)</label>
                <input type="number" id="conta-saldo" step="0.01" value="0">
            </div>
            <div class="modal-acts">
                <button type="button" class="btn btn-outline" onclick="closeContaModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Salvar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal: Transferencia entre Contas -->
<div id="modal-transfer" class="modal-bg" onclick="if(event.target===this)closeTransferModal()">
    <div class="modal">
        <h3>Registrar Transferencia</h3>
        <p id="transfer-desc">Selecione a conta destino para esta movimentacao.</p>
        <form id="transfer-form" onsubmit="saveTransfer(event)">
            <input type="hidden" id="transfer-tx-id">
            <div class="form-group">
                <label>Transacao</label>
                <input type="text" id="transfer-label" disabled style="background:var(--bg);color:var(--t2)">
            </div>
            <div class="form-group">
                <label>Valor</label>
                <input type="text" id="transfer-valor" disabled style="background:var(--bg);color:var(--t2);font-family:'JetBrains Mono',monospace">
            </div>
            <div class="form-group">
                <label>Conta Destino</label>
                <select id="transfer-conta-destino" required>
                    <option value="">Selecione a conta...</option>
                </select>
            </div>
            <div class="modal-acts">
                <button type="button" class="btn btn-outline" onclick="closeTransferModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Confirmar Transferencia</button>
            </div>
        </form>
    </div>
</div>

<script>
const API=window.__GUARDIAN_API_BASE__||(window.location.hostname==='localhost'||window.location.hostname==='127.0.0.1'?'http://localhost:7071':'https://func-guardian-sovereign.azurewebsites.net');
const KEY=window.__GUARDIAN_API_KEY__||'';
let forecastChart=null, billingChart=null;
let dashData=null;
let categoriasCache=[];
// GAP #8: Project cache for linking transactions to projects
let projetosCache=[];

// GAP #2: Azure AD (MSAL) Authentication
const AAD_CLIENT_ID=window.__AAD_CLIENT_ID__||'';
const AAD_TENANT_ID=window.__AAD_TENANT_ID__||'';
let msalInstance=null;
let authToken=null;

if(AAD_CLIENT_ID&&typeof msal!=='undefined'){
    msalInstance=new msal.PublicClientApplication({
        auth:{clientId:AAD_CLIENT_ID,authority:'https://login.microsoftonline.com/'+AAD_TENANT_ID,redirectUri:window.location.origin},
        cache:{cacheLocation:'localStorage',storeAuthStateInCookie:true}
    });
    msalInstance.initialize().then(()=>{
        const accounts=msalInstance.getAllAccounts();
        if(accounts.length>0){
            msalInstance.acquireTokenSilent({scopes:['api://'+AAD_CLIENT_ID+'/.default'],account:accounts[0]})
                .then(r=>{authToken=r.accessToken;loadDashboard()})
                .catch(()=>msalInstance.loginRedirect({scopes:['api://'+AAD_CLIENT_ID+'/.default']}));
        }else{
            msalInstance.handleRedirectPromise().then(r=>{
                if(r){authToken=r.accessToken;loadDashboard()}
                else msalInstance.loginRedirect({scopes:['api://'+AAD_CLIENT_ID+'/.default']});
            });
        }
    });
}

function api(p){const b=API+p;return KEY?b+(b.includes('?')?'&':'?')+'code='+KEY:b}

// GAP #2: Override fetch to include Bearer token when available
const _origFetch=window.fetch;
window.fetch=function(url,opts){
    if(authToken&&typeof url==='string'&&url.includes('/api/')){
        opts=opts||{};
        opts.headers=opts.headers||{};
        if(typeof opts.headers==='object'&&!Array.isArray(opts.headers))opts.headers['Authorization']='Bearer '+authToken;
    }
    return _origFetch.call(this,url,opts);
};
function esc(s){const d=document.createElement('div');d.appendChild(document.createTextNode(s));return d.innerHTML}
function brl(v){return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0)}
function toast(m,t){const e=document.createElement('div');e.className='toast toast-'+(t||'info');e.textContent=m;document.getElementById('toasts').appendChild(e);setTimeout(()=>e.remove(),5000)}

// ---- Navigation ----
function navigateTo(page){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.sidebar-item[data-page]').forEach(i=>i.classList.remove('active'));
    const el=document.getElementById('page-'+page);
    if(el)el.classList.add('active');
    const nav=document.querySelector('.sidebar-item[data-page="'+page+'"]');
    if(nav)nav.classList.add('active');
    window.location.hash=page;
}

document.querySelector('.sidebar').addEventListener('click',function(e){
    const item=e.target.closest('.sidebar-item');
    if(!item)return;
    const page=item.dataset.page;
    if(page)navigateTo(page);
});

// ---- Tab switching ----
document.addEventListener('click',function(e){
    const btn=e.target.closest('.tab-btn');
    if(!btn)return;
    const bar=btn.closest('.tab-bar');
    const page=btn.closest('.page');
    if(!bar||!page)return;
    bar.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    page.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
    const panel=document.getElementById(btn.dataset.tab);
    if(panel)panel.classList.add('active');
    if(typeof lucide!=='undefined')lucide.createIcons();
});

// Auth
let user=null;
async function checkAuth(){
    try{const r=await fetch('/.auth/me');const d=await r.json();
        if(d.clientPrincipal){user=d.clientPrincipal;document.getElementById('user-name').textContent=user.userDetails;document.getElementById('user-role').textContent='Autenticado';document.getElementById('user-avatar').textContent=user.userDetails.charAt(0).toUpperCase()}
    }catch{document.getElementById('user-name').textContent='Desenvolvimento';document.getElementById('user-role').textContent='Ambiente local';document.getElementById('user-avatar').textContent='D'}
}
function handleAuth(){user?window.location.href='/.auth/logout':window.location.href='/.auth/login/aad'}

// Toast + Sync
async function runSync(){
    const btn=document.getElementById('btn-sync');btn.disabled=true;
    btn.innerHTML='<span class="spinner" style="width:14px;height:14px;border-width:2px"></span> Sincronizando...';
    try{const r=await fetch(api('/api/guardianSync'),{method:'POST'});
        if(r.status===401){toast('Login necessario.','err');return}
        if(!r.ok)throw new Error('Status '+r.status);
        const d=await r.json();
        if(d.success){toast(d.summary.transactions+' transacoes sincronizadas.','ok');loadDashboard()}
    }catch(e){toast('Erro: '+e.message,'err')}
    finally{btn.disabled=false;btn.innerHTML='<i data-lucide="refresh-cw" style="width:14px;height:14px"></i> Sincronizar';lucide.createIcons()}
}

// File upload
function handleDrop(e){e.preventDefault();document.querySelectorAll('.upload-zone').forEach(z=>z.classList.remove('drag'));if(e.dataTransfer.files.length)uploadFile(e.dataTransfer.files[0])}
function handleFileSelect(e){if(e.target.files.length)uploadFile(e.target.files[0])}
async function uploadFile(file){
    const s=document.getElementById('upload-status');
    s.innerHTML='<div style="display:flex;align-items:center;gap:8px"><span class="spinner" style="width:14px;height:14px;border-width:2px"></span><span style="font-size:12px;color:var(--t2)">Processando <strong>'+esc(file.name)+'</strong>...</span></div>';
    try{
        const b64=await new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result.split(',')[1]);r.onerror=rej;r.readAsDataURL(file)});
        const r=await fetch(api('/api/guardianUpload'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({filename:file.name,contentBase64:b64})});
        if(!r.ok)throw new Error('Status '+r.status);
        const d=await r.json();
        s.innerHTML='<div style="font-size:12px;color:var(--success);padding:8px 0">'+esc(d.message)+'</div>';
        toast(d.message,'ok');loadDashboard();
    }catch(e){s.innerHTML='<div style="font-size:12px;color:var(--danger)">Erro: '+esc(e.message)+'</div>'}
}

// ---- Approval Actions ----
// GAP #14: Read competência override from the row's month input
function getCompetenciaOverride(id){
    const el=document.getElementById('comp-'+id);
    if(el&&el.value)return el.value+'-01'; // YYYY-MM → YYYY-MM-01
    return undefined;
}
async function approveItem(id){
    try{
        const payload={id,action:'approve'};
        const dc=getCompetenciaOverride(id);
        if(dc)payload.dataCompetencia=dc;
        // GAP #8: attach project link if selected
        const projEl=document.getElementById('proj-'+id);
        if(projEl&&projEl.value)payload.projetoId=projEl.value;
        const r=await fetch(api('/api/guardianApprove'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        if(!r.ok)throw new Error('Status '+r.status);
        toast('Transacao aprovada.','ok');loadDashboard();
    }catch(e){toast('Erro: '+e.message,'err')}
}

async function rejectItem(id){
    try{const r=await fetch(api('/api/guardianApprove'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,action:'reject'})});
        if(!r.ok)throw new Error('Status '+r.status);
        toast('Transacao rejeitada.','ok');loadDashboard();
    }catch(e){toast('Erro: '+e.message,'err')}
}

// ---- Renderers ----
function renderPatrimonio(t){
    const grid=document.getElementById('patrimonio-grid');
    if(!grid||!t)return;
    // If dynamic accounts are loaded, they handle the patrimonio grid
    if(contasCache&&contasCache.length>0)return;
    let html='<div class="patrimonio-card cc"><div class="patrimonio-label">Conta Corrente</div><div class="patrimonio-nome">Banco Inter PJ</div><div class="patrimonio-valor" style="color:var(--info)">'+brl(t.caixaAtual)+'</div></div>';
    html+='<div class="patrimonio-card total"><div class="patrimonio-label">Patrimonio Total</div><div class="patrimonio-nome">Conta Corrente</div><div class="patrimonio-valor" style="color:var(--primary)">'+brl(t.caixaAtual)+'</div></div>';
    grid.innerHTML=html;
}

function renderInsights(insights,targetId){
    const el=document.getElementById(targetId);
    if(!el)return;
    if(!insights||!insights.length){el.innerHTML='<div class="empty-state">Nenhum insight disponivel.</div>';return}
    el.innerHTML=insights.map(i=>'<div class="insight-card '+esc(i.type||'info')+'"><div class="insight-title">'+esc(i.title||'')+'</div><div class="insight-text">'+esc(i.text||'')+'</div></div>').join('');
}

function renderBillingChart(history){
    const ce=document.getElementById('billing-chart');if(!ce)return;
    const ctx=ce.getContext('2d');
    if(billingChart)billingChart.destroy();
    if(!history||!history.length){return}
    billingChart=new Chart(ctx,{
        type:'bar',
        data:{labels:history.map(h=>h.month),datasets:[
            {label:'Receita',data:history.map(h=>h.receita),backgroundColor:'rgba(13,150,104,0.7)',borderRadius:4},
            {label:'Despesas',data:history.map(h=>h.despesas),backgroundColor:'rgba(217,48,54,0.7)',borderRadius:4},
        ]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{font:{size:11,family:'Inter'},usePointStyle:true,pointStyle:'circle',padding:16}},tooltip:{backgroundColor:'#1A1D26',padding:10,cornerRadius:8,callbacks:{label:c=>' '+c.dataset.label+': '+brl(c.raw)}}},scales:{y:{ticks:{callback:v=>'R$ '+(v/1000).toFixed(0)+'k',font:{size:10},color:'#9096A2'},grid:{color:'rgba(0,0,0,0.04)'},border:{display:false}},x:{ticks:{font:{size:10},color:'#9096A2'},grid:{display:false},border:{display:false}}}}
    });
}

function renderForecast(fc,canvasId){
    const fce=document.getElementById(canvasId);if(!fce||!fc||!fc.length)return;
    const ctx=fce.getContext('2d');
    if(forecastChart)forecastChart.destroy();
    const chart=new Chart(ctx,{
        type:'line',
        data:{labels:fc.map(f=>f.month),datasets:[
            {label:'Receita',data:fc.map(f=>f.receita),borderColor:'#0D9668',backgroundColor:'rgba(13,150,104,0.06)',fill:true,tension:0.35,borderWidth:2,pointRadius:4,pointBackgroundColor:'#fff',pointBorderColor:'#0D9668',pointBorderWidth:2},
            {label:'Despesas',data:fc.map(f=>f.despesas),borderColor:'#D93036',backgroundColor:'rgba(217,48,54,0.04)',fill:true,tension:0.35,borderWidth:2,pointRadius:4,pointBackgroundColor:'#fff',pointBorderColor:'#D93036',pointBorderWidth:2},
            {label:'Caixa Acumulado',data:fc.map(f=>f.caixaAcumulado),borderColor:'#5746AF',backgroundColor:'rgba(87,70,175,0.04)',fill:true,tension:0.35,borderWidth:2.5,pointRadius:4,pointBackgroundColor:'#fff',pointBorderColor:'#5746AF',pointBorderWidth:2,yAxisID:'y1'}
        ]},
        options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{position:'top',labels:{font:{size:11,family:'Inter',weight:'500'},usePointStyle:true,pointStyle:'circle',padding:20}},tooltip:{backgroundColor:'#1A1D26',titleFont:{size:12,family:'Inter'},bodyFont:{size:12,family:'JetBrains Mono'},padding:12,cornerRadius:8,callbacks:{label:c=>' '+c.dataset.label+': '+brl(c.raw)}}},scales:{y:{position:'left',ticks:{callback:v=>'R$ '+(v/1000).toFixed(0)+'k',font:{size:10},color:'#9096A2'},grid:{color:'rgba(0,0,0,0.04)'},border:{display:false}},y1:{position:'right',ticks:{callback:v=>'R$ '+(v/1000).toFixed(0)+'k',font:{size:10},color:'#9096A2'},grid:{display:false},border:{display:false}},x:{ticks:{font:{size:11},color:'#9096A2'},grid:{display:false},border:{display:false}}}}
    });
    forecastChart=chart;
}

function renderDRE(dre){
    const el=document.getElementById('dre-body');if(!el||!dre)return;
    const r=(l,v,c)=>'<tr class="'+(c||'')+'"><td>'+l+'</td><td class="num '+(typeof v==='number'&&v<0?'negative':'')+'">'+
        (typeof v==='number'?brl(v):(v||'--'))+'</td></tr>';
    const m=(l,pct)=>'<tr style="background:var(--primary-dim)"><td style="font-weight:600;color:var(--primary)">'+l+'</td><td class="num" style="font-weight:700;color:var(--primary)">'+(pct||'--')+'</td></tr>';
    const sec=(l)=>'<tr class="section-row"><td colspan="2">'+l+'</td></tr>';
    // Custos Variaveis sub-items
    let varRows='';
    if(dre.variaveis&&dre.variaveis.grupos){Object.entries(dre.variaveis.grupos).forEach(([g,v])=>{varRows+=r('(-) '+g,-(v||0),'sub')})}
    // Custos Fixos sub-items
    let fixRows='';
    if(dre.fixos&&dre.fixos.grupos){Object.entries(dre.fixos.grupos).forEach(([g,v])=>{fixRows+=r('(-) '+g,-(v||0),'sub')})}
    // Desp Financeiras sub-items
    let dfRows='';
    if(dre.resultadoFinanceiro&&dre.resultadoFinanceiro.despesasFinanceiras&&dre.resultadoFinanceiro.despesasFinanceiras.grupos){
        Object.entries(dre.resultadoFinanceiro.despesasFinanceiras.grupos).forEach(([g,v])=>{dfRows+=r('(-) '+g,-(v||0),'sub')})
    }
    const rf=dre.resultadoFinanceiro||{};
    el.innerHTML='<table class="tbl"><thead><tr><th>Conta</th><th>Valor</th></tr></thead><tbody>'+
        sec('RECEITA')+
        r('(+) Receita Bruta',dre.receitaBruta,'')+
        r('(-) Deducoes PIS/COFINS/ISS',-dre.deducoes,'sub')+
        r('= Receita Liquida',dre.receitaLiquida,'')+
        sec('CUSTOS E DESPESAS VARIAVEIS')+
        varRows+
        r('Total Variaveis',-(dre.variaveis?.total||0),'')+
        r('= MARGEM DE CONTRIBUICAO',dre.margemContribuicao,'')+
        m('INDICE MC',dre.margemContribuicaoFmt)+
        sec('CUSTOS E DESPESAS FIXOS')+
        fixRows+
        r('Total Fixos',-(dre.fixos?.total||0),'')+
        r('= RESULTADO OPERACIONAL',dre.resultadoOperacional,'')+
        m('MARGEM OPERACIONAL',dre.margemOperacional)+
        sec('RESULTADO FINANCEIRO')+
        r('(+) Receitas Financeiras',rf.receitasFinanceiras||0,'sub')+
        dfRows+
        r('= Resultado Financeiro Liquido',rf.liquido||0,'')+
        r('= Resultado Antes IR',dre.resultadoAntesIR,'')+
        r('(-) IR / CSLL (34%)',-dre.irCSLL,'sub')+
        r('= RESULTADO LIQUIDO',dre.resultadoLiquido,'total')+
        m('MARGEM LIQUIDA',dre.margemLiquida)+
        '<tr style="background:#FFF7ED;border-top:2px solid #F59E0B"><td style="font-weight:600;color:#B45309">PONTO DE EQUILIBRIO</td><td class="num" style="font-weight:700;color:#B45309">'+brl(dre.pontoEquilibrio)+'</td></tr>'+
        '</tbody></table>';
}

function renderDFC(dfc){
    const el=document.getElementById('dfc-body');if(!el||!dfc)return;
    const r=(l,v,c)=>'<tr class="'+(c||'')+'"><td>'+l+'</td><td class="num '+(typeof v==='number'&&v<0?'negative':typeof v==='number'&&v>0?'positive':'')+'">'+
        (typeof v==='number'?brl(v):(v||'--'))+'</td></tr>';
    const op=dfc.operacional||{};
    const fin=dfc.financeiro||{};
    el.innerHTML='<table class="tbl"><thead><tr><th>Fluxo</th><th>Valor</th></tr></thead><tbody>'+
        '<tr class="section-row"><td colspan="2">Atividades Operacionais</td></tr>'+
        r('(+) Recebimentos de Clientes',op.recebimentosClientes||0,'sub')+
        r('(-) Custos Variaveis',op.custosVariaveis||0,'sub')+
        r('(-) Custos Fixos',op.custosFixos||0,'sub')+
        r('= Caixa Operacional',op.total||0,'')+
        '<tr class="section-row"><td colspan="2">Atividades Financeiras</td></tr>'+
        r('(+) Receitas Financeiras',fin.receitasFinanceiras||0,'sub')+
        r('(-) Despesas Financeiras',fin.despesasFinanceiras||0,'sub')+
        r('= Caixa Financeiro',fin.total||0,'')+
        r('= Variacao Liquida',dfc.variacaoLiquida||0,'total')+
        r('Caixa Inicial',dfc.caixaInicial||0,'')+
        r('Caixa Final',dfc.caixaFinal||0,'')+
        '</tbody></table>';
}

function renderCats(cats){
    const el=document.getElementById('cat-list');if(!el)return;
    if(!cats||!cats.length){el.innerHTML='<div class="empty-state">Sem dados.</div>';return}
    const max=cats[0].total||1;
    el.innerHTML=cats.map(c=>{
        const pct=max>0?Math.round((c.total/max)*100):0;
        return '<div class="cat-row"><div class="cat-top"><span class="cat-name">'+esc(c.category)+'</span><span class="cat-val">'+brl(c.total)+'</span></div><div class="cat-bar-bg"><div class="cat-bar-fill" style="width:'+pct+'%"></div></div><div class="cat-count">'+c.count+' item(ns)</div></div>'
    }).join('');
}

function buildCatOptions(){
    const byTipo={};
    categoriasCache.forEach(c=>{if(!byTipo[c.tipo])byTipo[c.tipo]=[];byTipo[c.tipo].push(c)});
    const order=['RECEITA_DIRETA','RECEITA_FINANCEIRA','CUSTO_VARIAVEL','CUSTO_FIXO','DESPESA_FINANCEIRA'];
    let html='';
    order.forEach(tipo=>{
        const items=byTipo[tipo]||[];if(!items.length)return;
        html+='<optgroup label="'+(TIPO_LABELS[tipo]||tipo)+'">';
        items.forEach(c=>{html+='<option value="'+esc(c.nome)+'">'+esc(c.nome)+'</option>'});
        html+='</optgroup>';
    });
    return html;
}

function renderApprovalList(items,movInternas){
    const el=document.getElementById('approval-list');if(!el)return;
    // Merge: regular pending + mov internas (tagged)
    const all=[];
    (items||[]).forEach(i=>{all.push({...i,_tipo:'pending'})});
    (movInternas||[]).forEach(i=>{all.push({...i,_tipo:'interna'})});
    if(!all.length){el.innerHTML='<div class="empty-state">Nenhuma transacao pendente de aprovacao.</div>';return}
    const catOpts=buildCatOptions();
    el.innerHTML=all.map(i=>{
        const cls=esc(i.classificacao||'');
        const desc=i.descricao?esc(i.descricao):'';
        const isInterna=i._tipo==='interna';
        const conf=typeof i.confianca==='number'?Math.round(i.confianca*100):0;
        const isCredit=i.classificacao&&i.classificacao.includes('Receita');
        const dotCls=isInterna?'':isCredit?'in':'out';
        const dotStyle=isInterna?' style="background:var(--info)"':'';
        const tagHtml=isInterna?'<span class="tag" style="background:var(--info-dim);color:var(--info)">Mov. Interna</span>':'<span class="tag tag-review">'+conf+'% conf.</span>';
        const amountColor=isInterna?'var(--t2)':(isCredit?'var(--success)':'var(--t1)');
        // GAP #14: Competência month input — default to transaction month
        const compDefault=i.dataCompetencia?i.dataCompetencia.substring(0,7):(i.data?i.data.substring(0,7):'');
        const compInput='<input type="month" id="comp-'+esc(i.id)+'" value="'+compDefault+'" title="Mes de competencia" style="width:120px;padding:4px 8px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--t1);font-size:11px;font-family:JetBrains Mono,monospace">';
        // GAP #8: Project link select
        const projOpts=projetosCache.length>0?projetosCache.map(p=>'<option value="'+esc(p.id)+'"'+(i.projetoId===p.id?' selected':'')+'>'+esc(p.nome)+'</option>').join(''):'';
        const projInput=projOpts?'<select id="proj-'+esc(i.id)+'" title="Vincular projeto" style="width:130px;padding:4px 8px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--t1);font-size:11px"><option value="">Projeto...</option>'+projOpts+'</select>':'';
        // Actions
        let acts='';
        if(isInterna){
            acts='<button class="btn btn-outline btn-sm" onclick="openTransferModal(\''+esc(i.id)+'\',\''+esc(cls)+'\','+((i.valor)||0)+')"><i data-lucide="arrow-right-left" style="width:12px;height:12px"></i> Transferencia</button>'+
                '<button class="btn btn-success btn-sm" onclick="approveItem(\''+esc(i.id)+'\')">Confirmar</button>'+
                '<button class="btn btn-danger btn-sm" onclick="rejectItem(\''+esc(i.id)+'\')">Rejeitar</button>';
        }else{
            acts='<select class="reclass-select" onchange="reclassifyItem(\''+esc(i.id)+'\',this)"><option value="">Reclassificar...</option>'+catOpts+'</select>'+
                '<button class="btn btn-success btn-sm" onclick="approveItem(\''+esc(i.id)+'\')">Aprovar</button>'+
                '<button class="btn btn-danger btn-sm" onclick="rejectItem(\''+esc(i.id)+'\')">Rejeitar</button>';
        }
        return '<div class="tx-row"><div class="tx-left"><div class="tx-dot '+dotCls+'"'+dotStyle+'></div><div style="min-width:0"><div class="tx-name">'+cls+'</div><div class="tx-meta"><span>'+desc+'</span></div><div class="tx-meta"><span>'+esc(i.data||'')+'</span>'+tagHtml+'</div></div></div><div style="display:flex;align-items:center;gap:12px">'+projInput+compInput+'<div><div class="tx-amount" style="color:'+amountColor+'">'+brl(i.valor)+'</div></div><div class="tx-actions">'+acts+'</div></div></div>'
    }).join('');
    if(typeof lucide!=='undefined')lucide.createIcons();
}

// ---- Transfer Modal ----
function openTransferModal(txId,label,valor){
    document.getElementById('transfer-tx-id').value=txId;
    document.getElementById('transfer-label').value=label;
    document.getElementById('transfer-valor').value=brl(valor);
    const sel=document.getElementById('transfer-conta-destino');
    sel.innerHTML='<option value="">Selecione a conta...</option>'+
        contasCache.map(c=>'<option value="'+esc(c.id)+'">'+esc(c.nome)+' ('+esc(c.banco||'')+')</option>').join('');
    document.getElementById('modal-transfer').classList.add('open');
}
function closeTransferModal(){document.getElementById('modal-transfer').classList.remove('open')}

async function saveTransfer(e){
    e.preventDefault();
    const txId=document.getElementById('transfer-tx-id').value;
    const contaDestino=document.getElementById('transfer-conta-destino').value;
    if(!contaDestino){toast('Selecione a conta destino.','err');return}
    try{
        const r=await fetch(api('/api/guardianApprove'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:txId,action:'transfer',contaDestino})});
        if(!r.ok)throw new Error('Status '+r.status);
        toast('Transferencia registrada.','ok');closeTransferModal();loadDashboard();
    }catch(err){toast('Erro: '+err.message,'err')}
}

function renderTxList(elId,items,type){
    const el=document.getElementById(elId);if(!el)return;
    if(!items||!items.length){el.innerHTML='<div class="empty-state">Nenhum registro.</div>';return}
    el.innerHTML=items.slice(0,15).map(i=>{
        return '<div class="tx-row"><div class="tx-left"><div class="tx-dot '+type+'"></div><div style="min-width:0"><div class="tx-name">'+esc(i.classificacao||'')+'</div><div class="tx-meta"><span>'+esc(i.descricao||'')+'</span><span>'+esc(i.data||'')+'</span></div></div></div><div><div class="tx-amount" style="color:'+(type==='in'?'var(--success)':'var(--t1)')+'">'+brl(i.valor)+'</div></div></div>'
    }).join('');
}

// ---- Data Loading (Single BFF call) ----
function setEl(id,val){const e=document.getElementById(id);if(e)e.textContent=val}

async function loadDashboard(){
    function safe(label,fn){try{fn()}catch(e){console.error('Dashboard ['+label+']:',e)}}
    try{
        const r=await fetch(api('/api/guardianDashboard'),{signal:AbortSignal.timeout(30000)});
        if(!r.ok)throw new Error('Status '+r.status);
        const d=await r.json();
        if(!d.success)throw new Error(d.error||'Erro');
        dashData=d;
        const h=d.home||{};
        const ind=h.indicators||{};
        const s=d.semanal||{};
        const m=d.mensal||{};

        // ---- HOME KPIs ----
        safe('home-kpi',function(){
            setEl('k-mb',ind.margemBruta||'0.0%');
            setEl('k-ml',ind.margemLiquida||'0.0%');
            setEl('k-lucro',brl(ind.lucroLiquido));
            setEl('k-fc',brl(ind.fluxoCaixa));
            setEl('k-fat',brl(ind.faturamentoAtual));
            setEl('k-pat',brl(ind.caixaAtual));
            var hp=document.getElementById('health-pill');
            if(hp){hp.textContent=ind.saudeFinanceira||'--';hp.className='pill '+(ind.saudeFinanceira==='saudavel'?'pill-success':'pill-primary')}
        });

        // ---- Dashboard Panels ----
        safe('dashboard-panels',function(){
            renderPatrimonio(h.treasury);
            // Prefer mensal insights (richer), fallback to home insights
            renderInsights(m.insights||h.insights,'insights-panel');
        });
        safe('dashboard-charts',function(){
            renderBillingChart(h.monthlyHistory);
            renderForecast(m.forecast||h.forecast,'forecast-chart');
        });
        safe('fc-panel',function(){
            var fp=document.getElementById('fc-panel');
            if(fp){fp.innerHTML=
                '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">'+
                '<div><div class="kpi-label">FC NECESSARIO</div><div style="font-size:20px;font-weight:700;color:var(--danger)">'+brl(h.fcNecessario)+'</div><div style="font-size:11px;color:var(--t3);margin-top:4px">Para cobrir despesas dos proximos '+(h.diasRestantesMes||0)+' dias</div></div>'+
                '<div><div class="kpi-label">FC PROJETADO</div><div style="font-size:20px;font-weight:700;color:'+((h.fcProjetado||0)>=0?'var(--success)':'var(--danger)')+'">'+brl(h.fcProjetado)+'</div><div style="font-size:11px;color:var(--t3);margin-top:4px">Projecao ate o fim do mes</div></div>'+
                '</div>'}
        });
        safe('panorama',function(){
            var pp=document.getElementById('panorama-panel');
            if(pp) pp.innerHTML=
                '<div style="display:grid;gap:12px">'+
                '<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span style="color:var(--t2)">Caixa Atual</span><strong>'+brl(ind.caixaAtual)+'</strong></div>'+
                '<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span style="color:var(--t2)">Faturamento</span><strong>'+brl(ind.faturamentoAtual)+'</strong></div>'+
                '<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span style="color:var(--t2)">Despesas Op.</span><strong style="color:var(--danger)">'+brl(ind.despesasOperacionais)+'</strong></div>'+
                '<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span style="color:var(--t2)">Indice MC</span><strong style="color:var(--success)">'+(ind.margemBruta||'--')+'</strong></div>'+
                '<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span style="color:var(--t2)">Margem Operacional</span><strong style="color:var(--primary)">'+(ind.margemOperacional||'--')+'</strong></div>'+
                '<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span style="color:var(--t2)">Margem Liquida</span><strong style="color:var(--primary)">'+(ind.margemLiquida||'--')+'</strong></div>'+
                '<div style="display:flex;justify-content:space-between;padding:8px 0"><span style="color:var(--t2);font-weight:600">Ponto de Equilibrio</span><strong style="color:#B45309">'+brl(ind.pontoEquilibrio)+'</strong></div>'+
                '</div>';
        });

        // GAP #8: Load projects for linking (non-blocking)
        fetch(api('/api/guardianAreas/operacoes')).then(r=>r.ok?r.json():null).then(d=>{
            if(d&&d.data&&d.data.projects)projetosCache=d.data.projects;
        }).catch(()=>{});

        // ---- SEMANAL PAGE ----
        var pendingList=s.transacoesEncontradas||[];
        categoriasCache=s.categorias||[];
        safe('semanal-kpi',function(){
            setEl('s-pending',pendingList.length);
            setEl('s-recebido',brl(s.totalJaRecebido));
            setEl('s-pago',brl(s.totalJaPago));
            setEl('s-alertas',s.alertas||0);
            setEl('auto-pill',(s.taxaAutomacao||'0%')+' auto');
            var badge=document.getElementById('approval-badge');
            var movInternas=s.movimentacoesInternas||[];
            var totalPending=pendingList.length+movInternas.length;
            if(badge){if(totalPending>0){badge.style.display='';badge.textContent=totalPending}else{badge.style.display='none'}}
        });
        safe('semanal-lists',function(){
            renderCategorias(categoriasCache);
            renderApprovalList(pendingList,s.movimentacoesInternas||[]);
            renderTxList('ja-pago-list',s.jaPago||[],'out');
            renderTxList('ja-recebido-list',s.jaRecebido||[],'in');
        });

        // ---- GUARDIAN: DRE, DFC, Categorias ----
        safe('guardian-tabs',function(){
            renderDRE(m.dre||{});
            renderDFC(m.dfc||{});
            renderCats(m.categorized||[]);
        });

        // Status
        safe('status',function(){
            var dotInter=document.getElementById('dot-inter');if(dotInter)dotInter.classList.add('live');
            var dotAi=document.getElementById('dot-ai');if(dotAi)dotAi.classList.add('live');
            var dotGraph=document.getElementById('dot-graph');if(dotGraph)dotGraph.classList.add('live');
            setEl('last-sync','Atualizado em '+new Date().toLocaleString('pt-BR'));
            if(typeof lucide!=='undefined')lucide.createIcons();
        });
    }catch(e){
        console.error('Dashboard fetch error:',e);
        toast('Erro ao carregar dashboard: '+e.message,'err');
        setEl('last-sync','Erro: '+e.message);
        ['dot-inter','dot-graph','dot-ai'].forEach(function(id){var el=document.getElementById(id);if(el)el.classList.remove('live')});
    }
}

// ---- Categorias CRUD ----

const TIPO_LABELS={'RECEITA_DIRETA':'Receita Direta','RECEITA_FINANCEIRA':'Receita Financeira','CUSTO_VARIAVEL':'Custo Variavel','CUSTO_FIXO':'Custo Fixo','DESPESA_FINANCEIRA':'Desp. Financeira'};
const GRUPO_POR_TIPO={
    'RECEITA_DIRETA':['Receita de Servicos','Outras Receitas Operacionais'],
    'RECEITA_FINANCEIRA':['Rendimentos Financeiros','Juros Ativos'],
    'CUSTO_VARIAVEL':['Subcontratacao','Infraestrutura Variavel','Comissoes','Marketing Performance','Impostos Variaveis','Insumos e Materiais'],
    'CUSTO_FIXO':['Pessoal','Ocupacao','Utilidades','Assinaturas e Licencas','Servicos Terceirizados','Administrativo','Outros'],
    'DESPESA_FINANCEIRA':['Juros e Encargos','Tarifas Bancarias','Outros'],
};

function renderCategorias(cats){
    categoriasCache=cats||[];
    const el=document.getElementById('categorias-list');if(!el)return;
    if(!cats||!cats.length){el.innerHTML='<div class="empty-state">Nenhuma categoria cadastrada.</div>';return}
    // Group by tipo
    const byTipo={};
    cats.forEach(c=>{if(!byTipo[c.tipo])byTipo[c.tipo]=[];byTipo[c.tipo].push(c)});
    let html='<table class="cad-tbl"><thead><tr><th>Nome</th><th>Tipo DRE</th><th>Grupo</th><th>Orcamento</th><th style="text-align:right">Acoes</th></tr></thead><tbody>';
    const order=['RECEITA_DIRETA','RECEITA_FINANCEIRA','CUSTO_VARIAVEL','CUSTO_FIXO','DESPESA_FINANCEIRA'];
    order.forEach(tipo=>{
        const items=byTipo[tipo]||[];
        if(!items.length)return;
        html+='<tr class="section-row"><td colspan="5">'+(TIPO_LABELS[tipo]||tipo)+'</td></tr>';
        items.forEach(c=>{
            html+='<tr><td>'+esc(c.nome)+'</td><td><span class="badge badge-'+esc(c.tipo)+'">'+(TIPO_LABELS[c.tipo]||c.tipo)+'</span></td><td style="font-size:11px;color:var(--t3)">'+esc(c.grupo||'')+'</td><td class="num">'+brl(c.orcamentoMensal)+'</td><td class="acts"><button class="btn btn-outline btn-sm" onclick="openCategoriaModal(\''+esc(c.id)+'\')">Editar</button> <button class="btn btn-danger btn-sm" onclick="deleteCategoria(\''+esc(c.id)+'\')">Desativar</button></td></tr>';
        });
    });
    html+='</tbody></table>';
    el.innerHTML=html;
}

function updateGrupoOptions(selectedGrupo){
    const tipo=document.getElementById('cat-tipo').value;
    const sel=document.getElementById('cat-grupo');
    const grupos=GRUPO_POR_TIPO[tipo]||['Outros'];
    sel.innerHTML=grupos.map(g=>'<option value="'+esc(g)+'"'+(g===selectedGrupo?' selected':'')+'>'+esc(g)+'</option>').join('');
}

function openCategoriaModal(editId){
    const m=document.getElementById('modal-categoria');
    const title=document.getElementById('modal-cat-title');
    const form=document.getElementById('cat-form');
    form.reset();
    if(editId){
        const c=categoriasCache.find(x=>x.id===editId);
        if(c){
            title.textContent='Editar Categoria';
            document.getElementById('cat-id').value=c.id;
            document.getElementById('cat-nome').value=c.nome;
            document.getElementById('cat-tipo').value=c.tipo;
            updateGrupoOptions(c.grupo);
            document.getElementById('cat-orcamento').value=c.orcamentoMensal||0;
        }
    }else{
        title.textContent='Nova Categoria';
        document.getElementById('cat-id').value='CAT_'+Date.now();
        updateGrupoOptions();
    }
    m.classList.add('open');
}

function closeCategoriaModal(){document.getElementById('modal-categoria').classList.remove('open')}

async function saveCategoria(e){
    e.preventDefault();
    const id=document.getElementById('cat-id').value;
    const nome=document.getElementById('cat-nome').value.trim();
    const tipo=document.getElementById('cat-tipo').value;
    const grupo=document.getElementById('cat-grupo').value;
    const orcamento=parseFloat(document.getElementById('cat-orcamento').value)||0;
    if(!nome){toast('Nome e obrigatorio.','err');return}
    const exists=categoriasCache.find(c=>c.id===id);
    const action=exists?'update':'create';
    const record={id,nome,tipo,grupo,orcamentoMensal:orcamento,ativa:true,criadoEm:exists?exists.criadoEm:new Date().toISOString()};
    try{
        const r=await fetch(api('/api/guardianCadastros/categorias'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action,record})});
        if(!r.ok)throw new Error('Status '+r.status);
        toast('Categoria salva.','ok');closeCategoriaModal();loadDashboard();
    }catch(err){toast('Erro: '+err.message,'err')}
}

async function deleteCategoria(id){
    if(!confirm('Desativar esta categoria?'))return;
    const cat=categoriasCache.find(c=>c.id===id);
    if(cat){
        const record={...cat,ativa:false};
        try{
            const r=await fetch(api('/api/guardianCadastros/categorias'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'update',record})});
            if(!r.ok)throw new Error('Status '+r.status);
            toast('Categoria desativada.','ok');loadDashboard();
        }catch(err){toast('Erro: '+err.message,'err')}
    }
}

async function reclassifyItem(id,selectEl){
    const newCat=selectEl.value;
    if(!newCat)return;
    try{
        const payload={id,action:'reclassify',classificacao:newCat};
        const dc=getCompetenciaOverride(id);
        if(dc)payload.dataCompetencia=dc;
        const r=await fetch(api('/api/guardianApprove'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        if(!r.ok)throw new Error('Status '+r.status);
        toast('Transacao reclassificada para: '+newCat,'ok');loadDashboard();
    }catch(err){toast('Erro: '+err.message,'err')}
}

// ---- Contas Correntes CRUD ----

const CONTA_TIPO_LABELS={'corrente':'Conta Corrente','poupanca':'Poupanca','investimento':'Investimento','cartao':'Cartao de Credito','caixa':'Caixa'};
let contasCache=[];

async function loadContas(){
    try{
        const r=await fetch(api('/api/guardianCadastros/contas'));
        if(!r.ok)throw new Error('Status '+r.status);
        const d=await r.json();
        contasCache=(d.records||[]).filter(c=>c.ativa!==false);
        renderContas(contasCache);
        renderPatrimonioDynamic(contasCache);
    }catch(e){console.error('loadContas:',e)}
}

function renderContas(contas){
    const el=document.getElementById('contas-list');if(!el)return;
    if(!contas||!contas.length){el.innerHTML='<div class="empty-state">Nenhuma conta cadastrada. Clique em "+ Nova Conta" para adicionar.</div>';return}
    let html='<table class="cad-tbl"><thead><tr><th>Nome</th><th>Banco</th><th>Tipo</th><th>Ag/Conta</th><th>Saldo Inicial</th><th style="text-align:right">Acoes</th></tr></thead><tbody>';
    contas.forEach(c=>{
        const tipoLabel=CONTA_TIPO_LABELS[c.tipo]||c.tipo;
        const agConta=(c.agencia||'')+(c.agencia&&c.conta?' / ':'')+(c.conta||'');
        html+='<tr><td><strong>'+esc(c.nome)+'</strong></td><td>'+esc(c.banco||'')+'</td><td><span class="badge badge-ativa">'+esc(tipoLabel)+'</span></td><td style="font-size:11px;color:var(--t3);font-family:JetBrains Mono,monospace">'+esc(agConta||'--')+'</td><td class="num">'+brl(c.saldoInicial)+'</td><td class="acts"><button class="btn btn-outline btn-sm" onclick="openContaModal(\''+esc(c.id)+'\')">Editar</button> <button class="btn btn-danger btn-sm" onclick="deleteConta(\''+esc(c.id)+'\')">Remover</button></td></tr>';
    });
    html+='</tbody></table>';
    el.innerHTML=html;
}

function renderPatrimonioDynamic(contas){
    const grid=document.getElementById('patrimonio-grid');if(!grid)return;
    if(!contas||!contas.length){
        // Fallback: show default if no accounts registered
        return;
    }
    let html='';
    let totalPatrimonio=0;
    contas.forEach(c=>{
        const cardClass=c.tipo==='investimento'?'inv':'cc';
        const colorVar=c.tipo==='investimento'?'var(--success)':'var(--info)';
        const tipoLabel=CONTA_TIPO_LABELS[c.tipo]||c.tipo;
        html+='<div class="patrimonio-card '+cardClass+'"><div class="patrimonio-label">'+esc(tipoLabel)+'</div><div class="patrimonio-nome">'+esc(c.nome)+'</div><div class="patrimonio-valor" style="color:'+colorVar+'">'+brl(c.saldoInicial)+'</div><div class="patrimonio-sub">'+esc(c.banco)+'</div></div>';
        totalPatrimonio+=c.saldoInicial||0;
    });
    html+='<div class="patrimonio-card total"><div class="patrimonio-label">Patrimonio Total</div><div class="patrimonio-nome">'+contas.length+' conta(s)</div><div class="patrimonio-valor" style="color:var(--primary)">'+brl(totalPatrimonio)+'</div></div>';
    grid.innerHTML=html;
}

function openContaModal(editId){
    const m=document.getElementById('modal-conta');
    const title=document.getElementById('modal-conta-title');
    const form=document.getElementById('conta-form');
    form.reset();
    if(editId){
        const c=contasCache.find(x=>x.id===editId);
        if(c){
            title.textContent='Editar Conta';
            document.getElementById('conta-id').value=c.id;
            document.getElementById('conta-nome').value=c.nome;
            document.getElementById('conta-banco').value=c.banco||'';
            document.getElementById('conta-tipo').value=c.tipo||'corrente';
            document.getElementById('conta-agencia').value=c.agencia||'';
            document.getElementById('conta-numero').value=c.conta||'';
            document.getElementById('conta-saldo').value=c.saldoInicial||0;
        }
    }else{
        title.textContent='Nova Conta Corrente';
        document.getElementById('conta-id').value='CC_'+Date.now();
    }
    m.classList.add('open');
}

function closeContaModal(){document.getElementById('modal-conta').classList.remove('open')}

async function saveConta(e){
    e.preventDefault();
    const id=document.getElementById('conta-id').value;
    const nome=document.getElementById('conta-nome').value.trim();
    const banco=document.getElementById('conta-banco').value.trim();
    const tipo=document.getElementById('conta-tipo').value;
    const agencia=document.getElementById('conta-agencia').value.trim();
    const conta=document.getElementById('conta-numero').value.trim();
    const saldoInicial=parseFloat(document.getElementById('conta-saldo').value)||0;
    if(!nome){toast('Nome e obrigatorio.','err');return}
    if(!banco){toast('Banco e obrigatorio.','err');return}
    const exists=contasCache.find(c=>c.id===id);
    const action=exists?'update':'create';
    const record={id,nome,banco,tipo,agencia,conta,saldoInicial,ativa:true,criadoEm:exists?exists.criadoEm:new Date().toISOString()};
    try{
        const r=await fetch(api('/api/guardianCadastros/contas'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action,record})});
        if(!r.ok)throw new Error('Status '+r.status);
        toast('Conta salva com sucesso.','ok');closeContaModal();loadContas();
    }catch(err){toast('Erro: '+err.message,'err')}
}

async function deleteConta(id){
    if(!confirm('Remover esta conta?'))return;
    const c=contasCache.find(x=>x.id===id);
    if(c){
        const record={...c,ativa:false};
        try{
            const r=await fetch(api('/api/guardianCadastros/contas'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'update',record})});
            if(!r.ok)throw new Error('Status '+r.status);
            toast('Conta removida.','ok');loadContas();
        }catch(err){toast('Erro: '+err.message,'err')}
    }
}

// Init
checkAuth();
const hash=window.location.hash.replace('#','');
if(hash&&['guardian','semanal','cadastros'].includes(hash))navigateTo(hash);
loadDashboard();
loadContas();
lucide.createIcons();
setInterval(loadDashboard,60000);
</script>
</body>
</html>
